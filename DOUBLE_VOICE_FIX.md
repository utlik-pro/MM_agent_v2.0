# üéôÔ∏è –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –¥–≤–æ–π–Ω–æ–≥–æ –≥–æ–ª–æ—Å–∞

## ‚ùå –ü—Ä–æ–±–ª–µ–º–∞
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–ª—ã—à–∞–ª–∏ **–¥–≤–∞ –≥–æ–ª–æ—Å–∞ –∞–≥–µ–Ω—Ç–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ** –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ "–ü–æ–∑–≤–æ–Ω–∏—Ç—å":
- –û–¥–∏–Ω –≥–æ–ª–æ—Å —Å–Ω–∞—á–∞–ª–∞, –∑–∞—Ç–µ–º –≤—Ç–æ—Ä–æ–π
- –ü–æ—Å–ª–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–ø—ã—Ç–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è/–æ—Ç–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º–∞ "—Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–ª–∞—Å—å"
- –≠—Ç–æ —É–∫–∞–∑—ã–≤–∞–ª–æ –Ω–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç–æ–≤ –∏–ª–∏ –∞—É–¥–∏–æ —Ç—Ä–µ–∫–æ–≤

## üîç –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã

### 1. **–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∏–∑–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–∞**
–í `api/token.py` –±—ã–ª–∞ —Ñ—É–Ω–∫—Ü–∏—è `dispatch_agent()` –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ–∑–¥–∞–≤–∞–ª–∞ –∞–≥–µ–Ω—Ç –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–Ω–∞—Ç—ã. –ù–æ LiveKit —É–∂–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–∏—Å–ø–µ—Ç—á–∏—Ä—É–µ—Ç –∞–≥–µ–Ω—Ç–æ–≤ –¥–ª—è –Ω–æ–≤—ã—Ö –∫–æ–º–Ω–∞—Ç ‚Üí **–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç–æ–≤**.

### 2. **–ù–µ–ø–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤**
–í `livekit-client.ts` –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–µ —É–¥–∞–ª—è–ª–∏—Å—å –∏–∑ DOM –ø–æ–ª–Ω–æ—Å—Ç—å—é, –æ—Å—Ç–∞–≤–∞–ª–∏—Å—å "–≤–∏—Å—è—á–∏–µ" —ç–ª–µ–º–µ–Ω—Ç—ã ‚Üí **–¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ audio —Ç—Ä–µ–∫–æ–≤**.

### 3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–∞—â–∏—Ç—ã –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è**
–ù–µ –±—ã–ª–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ —á—Ç–æ –∞—É–¥–∏–æ —Ç—Ä–µ–∫ —É–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω ‚Üí —Å–æ–∑–¥–∞–≤–∞–ª–∏—Å—å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ audio —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –æ–¥–Ω–æ–≥–æ —Ç—Ä–µ–∫–∞.

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. Backend (`api/token.py`)
**–£–¥–∞–ª–µ–Ω–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∏–∑–∞—Ü–∏—è –∞–≥–µ–Ω—Ç–∞:**

```python
# –£–î–ê–õ–ï–ù–û:
async def dispatch_agent(self, room_name, identity):
    # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞
    
# –ó–ê–ú–ï–ù–ï–ù–û –ù–ê:
agent_dispatched = "automatic"  # LiveKit —Å–∞–º –¥–∏—Å–ø–µ—Ç—á–∏—Ä—É–µ—Ç –∞–≥–µ–Ω—Ç–æ–≤
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –¢–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –∞–≥–µ–Ω—Ç —Å–æ–∑–¥–∞–µ—Ç—Å—è –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–Ω–∞—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

### 2. Frontend (`livekit-client.ts`)
**–î–æ–±–∞–≤–ª–µ–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤:**

```typescript
export class LiveKitVoiceClient {
  private audioElements: HTMLAudioElement[] = []; // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –ø–æ–¥–ø–∏—Å–∫–µ –Ω–∞ —Ç—Ä–µ–∫
  this.room.on(RoomEvent.TrackSubscribed, (track) => {
    const existingElement = this.audioElements.find(el => 
      el.srcObject === track.mediaStream
    );
    
    if (existingElement) {
      console.log('‚ö†Ô∏è Audio track already attached, skipping duplicate');
      return; // –ù–µ —Å–æ–∑–¥–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç
    }
    // ... —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
  });
}
```

**–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤:**

```typescript
private cleanupAudioElements(): void {
  this.audioElements.forEach(element => {
    element.pause();
    element.srcObject = null;
    if (element.parentNode) {
      element.parentNode.removeChild(element); // –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑ DOM
    }
  });
  this.audioElements = [];
}
```

**–£–ª—É—á—à–µ–Ω–∞ –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏:**

```typescript
async disconnect(): Promise<void> {
  this.cleanupAudioElements(); // –û—á–∏—Å—Ç–∫–∞ –ø–µ—Ä–µ–¥ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ–º
  // ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è
}
```

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

### –î–û –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ª—ã—à–∞–ª **2 –≥–æ–ª–æ—Å–∞ –∞–≥–µ–Ω—Ç–∞**
- üîÑ –ù—É–∂–Ω–æ –±—ã–ª–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è "—Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏"
- üêõ –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≥–µ–Ω—Ç–æ–≤ –∏ –∞—É–¥–∏–æ —Ç—Ä–µ–∫–æ–≤

### –ü–û–°–õ–ï –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- üéØ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ª—ã—à–∏—Ç **1 —á–µ—Ç–∫–∏–π –≥–æ–ª–æ—Å –∞–≥–µ–Ω—Ç–∞**
- ‚ö° –°—Ç–∞–±–∏–ª—å–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å –ø–µ—Ä–≤–æ–π –ø–æ–ø—ã—Ç–∫–∏
- üßπ –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç:
```bash
open test-double-voice-fix.html
```

### –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:
1. **–ü–µ—Ä–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ**: –ù–∞–∂–º–∏—Ç–µ "–ü–æ–∑–≤–æ–Ω–∏—Ç—å" ‚Üí –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –û–î–ò–ù –≥–æ–ª–æ—Å
2. **–û—Ç–∫–ª—é—á–µ–Ω–∏–µ**: –ù–∞–∂–º–∏—Ç–µ "–ó–∞–≤–µ—Ä—à–∏—Ç—å" ‚Üí –∞—É–¥–∏–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–µ–∫—Ä–∞—â–∞–µ—Ç—Å—è  
3. **–ü–æ–≤—Ç–æ—Ä–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ**: –°–Ω–æ–≤–∞ "–ü–æ–∑–≤–æ–Ω–∏—Ç—å" ‚Üí —Å–Ω–æ–≤–∞ –û–î–ò–ù –≥–æ–ª–æ—Å
4. **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å**: –ü–æ—Å–ª–µ 2-3 –ø–æ–ø—ã—Ç–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Å—Ç–∞–µ—Ç—Å—è —Å—Ç–∞–±–∏–ª—å–Ω—ã–º

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ:
- üìä **–í–∫–ª—é—á–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏** - –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ–∑–¥–∞–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è audio —ç–ª–µ–º–µ–Ω—Ç–æ–≤
- ‚úÖ **–°—Ç–∞—Ç—É—Å**: –î–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å "1 audio —ç–ª–µ–º–µ–Ω—Ç" –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
- ‚ö†Ô∏è **–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è**: –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ >1 audio —ç–ª–µ–º–µ–Ω—Ç–æ–≤

## üìã –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

### –õ–æ–≥–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è:
```
üöÄ Starting connection process...
üîä Audio track from agent received, creating audio element
‚úÖ Audio playbook started
üì¥ Track unsubscribed: audio
üóëÔ∏è Removing audio element from DOM
üßπ Cleaning up audio elements...
```

### –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è:
```
üì° Track subscribed: audio, trackSid: TR_xxx
‚ö†Ô∏è Audio track already attached, skipping duplicate
```

## üöÄ –°—Ç–∞—Ç—É—Å –¥–µ–ø–ª–æ—è
- ‚úÖ **Frontend**: –ó–∞–¥–µ–ø–ª–æ–µ–Ω –Ω–∞ Vercel (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
- ‚úÖ **Backend**: –û–±–Ω–æ–≤–ª–µ–Ω API —Ç–æ–∫–µ–Ω-—Å–µ—Ä–≤–µ—Ä
- ‚úÖ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –î–æ—Å—Ç—É–ø–Ω–æ —á–µ—Ä–µ–∑ `test-double-voice-fix.html`

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —É–ª—É—á—à–µ–Ω–∏–π
- üéØ **–¢–æ—á–Ω–∞—è –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∏–∑–∞—Ü–∏—è**: –¢–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∞–≥–µ–Ω—Ç—ã —Å–æ–∑–¥–∞—é—Ç—Å—è
- üßπ **–ß–∏—Å—Ç–∞—è –ø–∞–º—è—Ç—å**: –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ audio —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —É—Ç–µ—á–∫–∏
- üîí **–ò–∑–æ–ª—è—Ü–∏—è**: –ö–∞–∂–¥–∞—è —Å–µ—Å—Å–∏—è –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ–π

**–ü—Ä–æ–±–ª–µ–º–∞ –¥–≤–æ–π–Ω–æ–≥–æ –≥–æ–ª–æ—Å–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–µ–Ω–∞! üéâ** 